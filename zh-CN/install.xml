<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "LuoYunCloud_UserGuide.ent">
%BOOK_ENTITIES;
]>
<chapter id="chap-install">
  <title>安装 LuoYunCloud</title>
<!-- 开始获取安装文件-->
  <section>
    <title>获取安装文件</title>
    <para>请访问 <ulink url="http://dl.luoyun.co">落云下载中心</ulink> </para>
  </section>
<!-- 结束获取安装文件-->

<!-- 开始使用 LiveCD 安装-->
  <section>
    <title>使用 LiveCD 安装</title> 
    <procedure>
      <step>
	<title>安装 LiveCD</title>
	<orderedlist>
	  <listitem>
	    <para>从 LiveCD 启动计算机,自动登陆系统</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-1.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>点击【硬盘安装】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-2.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>点击【下一步】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-3.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>选择默认“美国英语式”，点击【下一步】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-4.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>选择默认“基本存储设备”，点击【下一步】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-5.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>选择“是，忽略所有数据”，点击【下一步】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-6.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	    
	  <listitem>
	    <para>自定义主机名称或默认，点击【下一步】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-7.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>选择默认“亚洲/上海”，点击【下一步】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-8.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>自定义输入”根密码“并”确认“填写”，点击【下一步】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-9.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>如果您的密码设置过于简单,会出现弹出框，继续使用该密码，点击【无论如何都使用】，点击【取消】重设密码</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-10.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>选择“使用所有空间”，点击【下一步】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-11.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>出现弹出框，点击【将修改写入磁盘】</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-12.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>等待安装</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-13.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-14.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  <listitem>
	    <para>出现下图界面，表示您的 LiveCD 安装完成，点击【关闭】，重启计算机，进入 LuoYunCloud 系统。</para>
	    <mediaobject>
	      <imageobject>
		<imagedata fileref="images/install/install-livecd-15.png" format="PNG"  align="center"/>
	      </imageobject>
	    </mediaobject>
	  </listitem>
	  
	</orderedlist>
      </step>
      <step>
	<title>配置 LuoYunCloud</title>
	<orderedlist>
	  <listitem>
	    <para>初始化 LuoYunCloud</para>
	    <para>请确认您已经在新安装的 LuoYunCloud 系统中，打开终端，运行初始化命令</para>
	    <programlisting>
# bash /opt/LuoYun/install/init-luoyuncloud.sh
	    </programlisting>
	  </listitem>
	  
	</orderedlist>
      </step>
      <step>
	<title>启动与停止 LuoYun 服务</title>
	<para>启动 LuoYun</para>
	<programlisting>
# /opt/LuoYun/bin/start
	</programlisting>
	<para>停止 LuoYu</para>
	<programlisting>
# /opt/LuoYun/bin/stop
	</programlisting>
      </step>
       <step>
	<title>创建我的虚拟机</title>
	<orderedlist>
	      <listitem>
		<para>打开浏览器，在地址栏输入<ulink url="http://127.0.0.1/"> 127.0.0.1</ulink> 并回车（按Enter 键）。</para>
	      </listitem>
	      <listitem>
		<para>点击右上角【登陆】按钮，输入默认用户名：admin、密码：admin 登陆</para>
	      </listitem>
	      <listitem>
		<para>点击【应用库】中的 owncloud 应用</para>
	      </listitem>
	      <listitem>
		<para>点击【创建虚拟机】</para>
	      </listitem>
	      <listitem>
		<para>“名字”“CPU个数”“内存（M）”“隐藏”，可以根据自身情况加以修改，修改完成，点击【Creat】</para>
	      </listitem>
	      <listitem>
		<para>点击  启动虚拟机</para>
	      </listitem>
	      <listitem>
		<para>启动完成，点击"IP地址“</para>
		<mediaobject>
		  <imageobject>
		    <imagedata fileref="images/install/start_instance.png" format="PNG"  align="center"/>
		  </imageobject>
		</mediaobject>
	      </listitem>
	      <listitem>
		<para>点击【进入 ownCloud 首页】进入虚拟机</para>
		<mediaobject>
		  <imageobject>
		    <imagedata fileref="images/install/view_instance.png" format="PNG"  align="center"/>
		  </imageobject>
		</mediaobject>
	      </listitem>
	      <listitem>
		<para>输入用户名：admin、密码：luoyun 登陆</para>
		<mediaobject>
		  <imageobject>
		    <imagedata fileref="images/install/owncloud_login.png" format="PNG"  align="center"/>
		  </imageobject>
		</mediaobject>
	      </listitem>
	      <listitem>
		<para>已进入 owncloud 应用，可以开始应用了 </para>
		<mediaobject>
		  <imageobject>
		    <imagedata fileref="images/install/owncloud_login2.png" format="PNG"  align="center"/>
		  </imageobject>
		</mediaobject>
	      </listitem>

	</orderedlist>
	<para>至此，您的第一台虚拟机，已创建完毕！</para>
      </step>
    </procedure>
  </section>
<!-- 结束使用 LiveCD 安装-->

<!--开始使用 yum 源安装 -->
  <section id="sec-yum-install">
    <title>使用 yum 源安装</title>
    <note>
      <title>环境要求</title>
      <para>本安装步骤适用于 <command>RHEL/CentOS 6.x</command> 64 位操作系统</para>
    </note>
    <para>为了方便大家更好的体验和部署 LuoYunCould 云计算系统，我们提供了 yum install 安装方式供大家使用。您只需要掌握 yum install 即可在您的计算机中快速的部署 LuoYunCloud 了。</para>
    <important><para>以下所有操作请使用 root 权限的帐户进行。</para></important>
    <procedure>
      <step>
      <title>将 LuoYunCloud 加入您的软件源中</title>
      <programlisting>
wget http://dl.luoyun.co/LuoYunCloud/0.5/RPMS/el6/x86_64/luoyuncloud.repo
mv luoyuncloud.repo /etc/yum.repos.d/luoyuncloud.repo
      </programlisting>
    </step>
    <step>
      <title>部署 LuoYunCloud 的主控服务器软件</title>
      <programlisting>
yum install luoyuncloud-web luoyuncloud-clc luoyuncloud-nginx
      </programlisting>
      <para>执行此条指令可以在您的机器上部署 lyweb 和 lyclc 这两项 LuoYunCloud 服务。</para>
      <para>执行完成后，这两项服务已经默认部署在 /opt/LuoYun 中，接下来您需要执行一次 lyweb 的安装。</para>
    </step>
    <step>
      <title>安装 lyweb 服务及 postgresql 数据库</title>
      <para>执行：</para>
      <programlisting>
/opt/LuoYun/install/install-web.sh
      </programlisting>
      <para>此指令将帮助您快速的完成 lyweb 服务及数据库的初始化安装。在执行过程中您需要输入数据库名称，建议使用 luoyun，输入2次后，将请求给以 luoyun 数据库高级权限，请输入 y 确认。</para>
      <para>得到如下反馈后,表示您的机器中已经安装 lyweb 及其所需要的数据库：</para>
      <programlisting>
[root@localhost ~]# /opt/LuoYun/install/install-web.sh
Initializing database:                                     [  OK  ]   # 注意，此处可能需要时间较长，请耐心等待即可。
Starting postgresql service:                               [  OK  ]
Create DB User
Enter password for new role:                                          # 此处请输入luoyun
Enter it again:                                                       # 再输入一次luoyun进行确认
Shall the new role be a superuser? (y/n)                              # 输入y，确认数据库权限
  => [DD] create user luoyun succeed
Create DB luoyun
  => [DD] create luoyun succeed
Stopping postgresql service:                               [  OK  ]
Starting postgresql service:                               [  OK  ]
DEBUG:Manage:build /opt/LuoYun/web/locale/zh_CN/LC_MESSAGES/luoyun.mo success
DEBUG:Manage:build /opt/LuoYun/web/locale/zh_CN/LC_MESSAGES/app.mo success
DEBUG:Manage:build /opt/LuoYun/web/locale/en_US/LC_MESSAGES/luoyun.mo success
DEBUG:Manage:build /opt/LuoYun/web/locale/en_US/LC_MESSAGES/app.mo success
[root@localhost ~]#
      </programlisting>
      <para>至此，上述提示信息即表示您已经成功完成 lyweb 的安装。</para>
      <important>
      <para>如果安装过程中出现错误提示，请执行下面的两条指令对数据库进行重置</para>
      <programlisting>
# service postgresql stop

# rm -rf /var/lib/pgsql/*
      </programlisting>
      <para>然后重新执行</para>
      <programlisting>
/opt/LuoYun/install/install-web.sh
      </programlisting>
      </important>
    </step>
    <step>
      <title>启动 lyweb 服务</title>
      <para>确定 postgresql 数据库已经启动。如未启动，用如下命令启动数据库</para>
      <programlisting>
service postgresql start
      </programlisting>
      <para>然后启动 lyweb</para>
      <programlisting>
service lyweb start
      </programlisting>
      <para>系统将显示</para>
      <programlisting>
Starting lyweb:   OK
      </programlisting>
      <para>表示 lyweb 服务已经成功启动。用户可通过浏览器访问当然机器上的 LuoYunCloud 了。</para>
    </step>
    <step>
      <title>启动 lyclc 服务</title>
      <programlisting>
service lyclc start
      </programlisting>
      <para>系统将显示</para>
      <programlisting>
Starting lyclc:   OK
      </programlisting>
      <para>表示机器上的 lyclc 服务启动成功，开始等待 lynode 服务器加入后开始提供创建虚拟机等服务。</para>
      <para>然后请执行下面的指令，打开 iptabe 的端口：</para>
      <programlisting>
iptables -I INPUT 1 -p tcp -m tcp --dport 1369 -j ACCEPT
iptables -I INPUT 1 -p tcp -m tcp --dport 80 -j ACCEPT
iptables -I INPUT 1 -p tcp -m tcp --dport 8080 -j ACCEPT
iptables -I INPUT 1 -p tcp -m tcp --dport 8001 -j ACCEPT
      </programlisting>
    </step>
    <step>
      <title>部署 LuoYunCloud 的节点服务器软件</title>
      <programlisting>
yum install luoyuncloud-node
      </programlisting>
      <para>执行完成即可。</para>
    </step>
    <step>
      <title>启动 lynode 节点服务</title>
      <programlisting>
service lynode start
      </programlisting>
      <para>系统将显示</para>
      <programlisting>
Starting lynode:   OK
      </programlisting>
      <para>表示机器上的 lynode 服务启动成功。</para>
      <para>至此，当前机器已经可以提供完整的 LuoYunCloud 云计算服务了。</para>
    </step>

    <step>
      <title>最后，将 LuoYunCloud 的各项服务配置成开机自启动</title>
      <para>首先，确定 iptables （防火墙）打开了如下端口。确定文件 /etc/sysconfig/iptables 包含以下内容。</para>
      <programlisting>
-A INPUT -p tcp -m tcp --dport 1369 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 8001 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 8080 -j ACCEPT
      </programlisting>
      <para>由于 iptables 规则顺序的执行方法，以上内容要在 </para>
      <programlisting>
-A INPUT -j REJECT --reject-with icmp-host-prohibited
      </programlisting>
      <para>这条规则之上。</para>
      <para>然后, 请执行下列命令将各项所需要的服务加入系统的自动启动列表。</para>
      <programlisting>
chkconfig postgresql on
chkconfig lyweb on
chkconfig lyclc on
chkconfig lynode on
      </programlisting>
      <para>加入成功后可以使用 chkconfig --list 查看服务自启动状态</para>
      <programlisting>
# chkconfig --list lyweb
lyweb           0:关闭  1:关闭  2:启用  3:启用  4:启用  5:启用  6:关闭
# chkconfig --list lyclc
lyclc           0:关闭  1:关闭  2:启用  3:启用  4:启用  5:启用  6:关闭
# chkconfig --list lynode
lynode          0:关闭  1:关闭  2:启用  3:启用  4:启用  5:启用  6:关闭
# chkconfig --list postgresql
postgresql      0:关闭  1:关闭  2:启用  3:启用  4:启用  5:启用  6:关闭
      </programlisting>
      <para>至此，LuoYunCloud 可以在系统启动后，自动启动。</para>
    </step>
    

    </procedure>

  </section>
<!--结束使用 yum 源安装-->

<!--开始从源代码安装-->
  <section>
    <title>从源代码安装</title>
    <para>未完待续...</para>
  </section>
<!--开始从源代码安装-->

<!-- 开始多节点安装部署-->
   <section>
    <title>多节点安装部署</title>
    <note><para>首先，确保单机部署的 LuoYunCloud 正常运行（参见<xref linkend="sec-yum-install"/>）。之后，在每台节点服务器（包括已经做为单机运行的节点），做如下配置和安装工作。以下说明假设节点服务器已经成功安装并运行 CentOS6 或是 RHEL6 Linux 操作系统。</para></note>
    <section>
      <title>配置节点网络为桥接模式</title>
      <para>首先运行下面的命令安装 bridge-utils 软件包</para>
      <programlisting>
yum install bridge-utils
      </programlisting>
      <para>进入 /etc/sysconfig/network-scripts 目录</para>
      <programlisting>
cd /etc/sysconfig/network-scripts
      </programlisting>
      <para>编辑 /etc/sysconfig/network-scripts/ifcfg-eth0 文件。如果该文件不存在，请确认 NetworkManager 处于关闭状态。然后，将 eth0 连接至 br0</para>
      <programlisting>
DEVICE=eth0
ONBOOT=yes
BRIDGE=br0
      </programlisting>
      <para>在此目录下新建 br0 的配置文件，/etc/sysconfig/network-scripts/ifcfg-br0，并将原先属于 eth0 的 IP，配置给新建的 br0 。例如</para>
      <programlisting>
DEVICE="br0" 
ONBOOT=yes
TYPE=Bridge
BOOTPROTO=none
IPADDR=192.168.1.2
GATEWAY=192.168.1.1
NETMASK=255.255.255.0
DELAY=0
      </programlisting>
      <para>重启 network 服务即可</para>
      <programlisting>
service network restart
      </programlisting>
    </section>

    <section>
      <title>安装并配置 lynode 节点服务程序</title>
      <para>确定节点服务程序已经安装。新增加的节点可以使用如下命令安装节点服务程序</para>
      <programlisting>
# wget http://dl.luoyun.co/LuoYunCloud/0.5/RPMS/el6/x86_64/luoyuncloud.repo 
# mv luoyuncloud.repo /etc/yum.repos.d/luoyuncloud.repo
# yum install luoyuncloud-node
      </programlisting>
      <para>然后修改 lynode 的配置文件 lynode.conf</para>
      <programlisting>
vi /opt/LuoYun/platform/etc/luoyun-cloud/lynode.conf
      </programlisting>
      <itemizedlist>
	<listitem>
	  <para>指定 lynode 与 lyclc 的连接方式，以及 lyclc 的 IP 地址。下述中的“192.168.1.1” IP 地址需换成用户所部署的 lyclc 的 IP 地址</para>
	  <programlisting>
LYCLC_AUTO_CONNECT = DISABLE
LYCLC_HOST = 192.168.1.1
LYCLC_PORT = 1369
	  </programlisting>
	</listitem>
	<listitem>
	  <para>指定网络连接方式</para>
	  <programlisting>
LYNODE_NET_PRIMARY = br0
	  </programlisting>
	</listitem>
      </itemizedlist>
      <para>保存后，重启 lynode 服务。lynode 会自动连接 lyclc 并注册</para>
      <programlisting>
service lynode restart
      </programlisting>
      <para>最后，需要登录管理后台，进入节点标签，勾选新加入的节点。</para>
    </section>

    <section>
      <title>部署完成后的注意事项</title>
      <itemizedlist>
	<listitem>
	  <para>在原单机部署时使用的虚拟机器，在平台转为多点部署后，需要修改/opt/LuoYun/platform/etc/luoyun-cloud/lynode.sysconf，只需修改LYCLC_HOST</para>
          <programlisting>
LYCLC_HOST = 192.168.122.1  #此处请改为新设置的IP地址
LYCLC_PORT = 1369 #此处不要修改
LYNODE_TAG = 3 #此处为节点在数据库中的编号，不要修改
LYNODE_SECRET = a91f69e3-950b-4977-9ea1-bc0f50154a0e #此处为节点注册密码，不要修改
	  </programlisting>
	  <para>然后，将原先创建的虚拟机重启，即可在多节点环境的LuoYunCloud平台上正常使用。</para>
	</listitem>
	<listitem>
	  <para>确定多点部署成功完成后，可以将节点服务器的操作系统设置为不启动图形界面，这样可以节省一部分计算资源供云平台使用</para>
	  <para>编辑 /etc/inittab 文件。找到 id:5: initdefault: 这一行，将它改为 id:3:initdefault: 后重新启动系统即可</para>
	</listitem>
      </itemizedlist>

    </section>

  </section>
 <!-- 结束多节点安装部署-->

</chapter>

